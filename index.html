<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NFC æ±‚è§£ä¹‹æ›¸ Demo</title>
  <style>
    body {
      font-family:"Microsoft JhengHei",sans-serif;
      color:#333;
      text-align:center;
      padding:2rem;
      background: url("book_bg1.jpg") no-repeat center center fixed;
      background-size: cover;
    }
    header { font-size:1.8rem;font-weight:bold;color:#4a2f00;margin-bottom:1rem;text-shadow:1px 1px 2px rgba(0,0,0,0.2);}
    .result { margin-top:2rem;padding:1.4rem;border-radius:12px;background:rgba(255,255,255,0.45);box-shadow:0 2px 8px rgba(0,0,0,0.15);font-size:1.5rem;line-height:1.8;}
    .notice { margin-top:1rem;color:#b22222;font-weight:bold;}
    .info { margin-top:0.8rem;font-size:0.9rem;color:#555;}
    .loading { margin-top:2rem;display:none;}
    .spinner {margin:0 auto 1rem;border:6px solid #eee;border-top:6px solid #7b5c2e;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;}
    @keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .typing { white-space:pre-wrap;text-align:center;}
    .divider { margin:1rem auto;width:200px;}
    #hint { margin-top:1rem;font-size:1rem;color:#333;font-weight:bold;}
    #saveBtn {margin-top:1rem; background:#7b5c2e; color:#fff; padding:0.6rem 1.2rem; border:none; border-radius:8px; cursor:pointer; font-size:0.9rem; box-shadow:0 2px 4px rgba(0,0,0,0.2); display:none;}
  </style>
</head>
<body>
  <header>ğŸ“– NFC æ±‚è§£ä¹‹æ›¸</header>
  <p>æ„Ÿæ‡‰ NFC é‘°åŒ™åœˆå³å¯æŠ½å‡ºä¸€å‰‡ç­”æ¡ˆ</p>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>ğŸ”® æ­£åœ¨ç‚ºä½ æŠ½å–ä»Šæ—¥ç­”æ¡ˆ...</p><br>
    <p id="hint">~ è«‹åœ¨å¿ƒä¸­é»˜å¿µè¦è§£ç­”çš„æ˜ç¢ºå•é¡Œ ~ <br>å¿ƒèª å‰‡éˆï¼</p>
  </div>

  <div id="output" class="result" style="display:none;">
    <p style="color:#555;font-size:1.3rem;">âœ¨ ä»Šæ—¥ç­”æ¡ˆ âœ¨</p>
    <p id="ansZh" class="typing"></p>
    <img src="dividing-lines-1.png" class="divider" alt="divider">
    <p id="ansEn" class="typing" style="color:#333;font-size:1.2rem;"></p>
  </div>

  <p id="notice" class="notice" style="display:none;"></p>
  <button id="saveBtn" onclick="saveResult()">ğŸ“œ æ”¶è—æ­¤è§£ç­”</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    function typeWriter(text, element, speed = 40, callback) {
      let i = 0; element.innerText = "";
      (function typing() {
        if (i < text.length) {
          element.innerText += text.charAt(i++);
          setTimeout(typing, speed);
        } else if (callback) callback();
      })();
    }

    async function drawAnswer() {
      try {
        const res = await fetch("/api/getAnswer");
        const data = await res.json();
        if (!data.success) throw new Error(data.error || "API error");

        const pick = data.answer;

        document.getElementById("loading").style.display = "block";
        document.getElementById("output").style.display = "none";
        document.getElementById("saveBtn").style.display = "none";

        const delay = 10000 + Math.random() * 2000;

        setTimeout(() => {
          document.getElementById("loading").style.display = "none";
          document.getElementById("hint").style.display = "none";
          document.getElementById("output").style.display = "block";

          typeWriter(pick.answer_tw, document.getElementById("ansZh"), 50, () => {
            typeWriter(pick.answer_en, document.getElementById("ansEn"), 40, () => {
              document.getElementById("saveBtn").style.display = "inline-block";
            });
          });
        }, delay);
      } catch (err) {
        document.getElementById("notice").innerText = "âš ï¸ ç„¡æ³•å–å¾—ç­”æ¡ˆï¼š" + err.message;
        document.getElementById("notice").style.display = "block";
      }
    }

    function saveResult() {
      const node = document.getElementById("output");
      const today = new Date().toISOString().slice(0, 10);
      let count = parseInt(localStorage.getItem("saveCount_" + today) || "0", 10) + 1;
      localStorage.setItem("saveCount_" + today, count);

      html2canvas(node, {backgroundColor: "#fdf6e3",padding: 10,scale: 2}).then(canvas => {
        const link = document.createElement("a");
        link.download = `answer_${today}_${count}.png`;
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    window.addEventListener("load", drawAnswer);
  </script>
</body>
</html>
